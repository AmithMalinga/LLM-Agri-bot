<!DOCTYPE html>
<html>
<head>
    <title>AgriBot - Your Smart Farming Assistant</title>
    <link rel="icon" type="image/x-icon" href="static/images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="This is an Agriculture chatbot that helps farmers to make write desitions." />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #2d6a4f;
            --secondary-green: #40916c;
            --light-green: #52b788;
            --accent-green: #74c69d;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text-dark: #1b4332;
            --text-gray: #6c757d;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 20px rgba(45, 106, 79, 0.15);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9f5f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-dark);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            padding: 30px;
            text-align: center;
            color: white;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 32px;
        }

        .disclaimer {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-light);
            scroll-behavior: smooth;
            min-height: 0;
        }

        #chat-container::-webkit-scrollbar {
            width: 8px;
        }

        #chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 10px;
        }

        .message-wrapper {
            margin-bottom: 16px;
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 15px;
            line-height: 1.5;
            box-shadow: var(--shadow);
        }

        .user-message .message-content {
            background: var(--primary-green);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message .message-content {
            background: white;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
            border-left: 3px solid var(--accent-green);
            line-height: 1.8;
        }

        /* Formatted text styling */
        .bot-message .message-content h3 {
            color: var(--primary-green);
            font-weight: 700;
            font-size: 17px;
            margin: 20px 0 12px 0;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--accent-green);
        }

        .bot-message .message-content h3:first-child {
            margin-top: 0;
        }

        .bot-message .message-content .list-item {
            margin: 12px 0;
            padding-left: 0;
        }

        .bot-message .message-content .list-item strong {
            color: var(--secondary-green);
            font-weight: 600;
            font-size: 15px;
        }

        .bot-message .message-content .list-item-content {
            display: block;
            margin-top: 4px;
            color: var(--text-dark);
            padding-left: 24px;
        }

        .bot-message .message-content .tip-section {
            margin-top: 20px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            border-left: 3px solid var(--light-green);
        }

        .bot-message .message-content .tip-title {
            color: var(--secondary-green);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .bot-message .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .bot-message .message-content ul li {
            margin: 6px 0;
            color: var(--text-dark);
        }

        .message-with-audio {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            max-width: 90%;
        }

        .bot-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--secondary-green), var(--light-green));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 22px;
            box-shadow: var(--shadow);
        }

        .message-content-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .audio-play-btn {
            background: var(--secondary-green);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-top: 4px;
        }

        .audio-play-btn:hover {
            background: var(--primary-green);
            transform: scale(1.1);
        }

        .audio-play-btn i {
            font-size: 16px;
        }

        .audio-play-btn.playing {
            background: var(--primary-green);
            animation: pulse 1.5s infinite;
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 18px;
            background: white;
            border-radius: 16px;
            color: var(--text-gray);
            font-style: italic;
            box-shadow: var(--shadow);
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary-green);
            animation: bounce 1.4s infinite ease-in-out;
        }

        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .input-section {
            padding: 24px;
            background: white;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        #user-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        #user-input:focus {
            outline: none;
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-green);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--accent-green);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: var(--light-green);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-recording {
            background: #dc3545;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        .controls-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        #audio {
            width: 100%;
            margin-top: 12px;
            border-radius: 12px;
            outline: none;
        }

        audio::-webkit-media-controls-panel {
            background: var(--bg-light);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: var(--bg-light);
            font-size: 14px;
            color: var(--text-gray);
        }

        .footer a {
            color: var(--primary-green);
            text-decoration: none;
            margin: 0 8px;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: var(--secondary-green);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 0;
                height: calc(100vh - 20px);
            }

            .header h1 {
                font-size: 22px;
            }

            .message-content {
                max-width: 85%;
            }

            .controls-row {
                grid-template-columns: 1fr;
            }
        }

        /* Language Selection Modal */
        .language-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .language-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .language-modal-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 10px;
        }

        .language-modal-subtitle {
            font-size: 16px;
            color: var(--text-gray);
            margin-bottom: 30px;
        }

        .language-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .language-btn {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
        }

        .language-btn:hover {
            border-color: var(--secondary-green);
            background: var(--bg-light);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .language-btn i {
            font-size: 32px;
            display: block;
            margin-bottom: 10px;
        }

        .lang-en i {
            color: #0052B4;
        }

        .lang-si i {
            color: #8B4513;
        }

        .language-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Weather Widget Styles */
        .weather-widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px 20px;
            margin: 12px 24px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--secondary-green);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .weather-widget.compact {
            padding: 10px 20px;
        }

        .weather-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
        }

        .weather-location-input {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
            transition: all 0.3s ease;
        }

        .weather-widget.compact .weather-location-input {
            display: none;
        }

        .weather-location-input input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .weather-location-input input:focus {
            border-color: var(--secondary-green);
        }

        .weather-location-input button {
            padding: 8px 16px;
            background: var(--secondary-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .weather-location-input button:hover {
            background: var(--primary-green);
            transform: translateY(-2px);
        }

        .weather-display {
            display: none;
        }

        .weather-display.active {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .weather-icon {
            font-size: 32px;
            line-height: 1;
        }

        .weather-temp-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .weather-location-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-green);
            margin: 0;
        }

        .weather-temp {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            line-height: 1;
        }

        .weather-description {
            color: var(--text-gray);
            font-size: 12px;
            text-transform: capitalize;
        }

        .weather-details {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
            margin-left: auto;
        }

        .weather-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .weather-detail-icon {
            font-size: 16px;
        }

        .weather-detail-label {
            display: none;
        }

        .weather-detail-value {
            font-weight: 600;
            color: var(--text-dark);
        }

        .weather-timestamp {
            display: none;
        }

        .weather-change-btn {
            padding: 6px 14px;
            background: transparent;
            color: var(--secondary-green);
            border: 1px solid var(--secondary-green);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .weather-change-btn:hover {
            background: var(--secondary-green);
            color: white;
        }

        .weather-change-btn i {
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .language-options {
                grid-template-columns: 1fr;
            }
            
            .weather-widget {
                margin: 12px 16px;
                padding: 10px 16px;
            }
            
            .weather-display.active {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .weather-details {
                margin-left: 0;
                gap: 12px;
            }
            
            .weather-temp {
                font-size: 20px;
            }
            
            .weather-icon {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- Language Selection Modal -->
    <div class="language-modal" id="languageModal">
        <div class="language-modal-content">
            <div class="language-modal-title">Welcome! ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä!</div>
            <div class="language-modal-subtitle">Please select your preferred language<br>‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂î‡∂∂‡∂ú‡∑ö ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</div>
            <div class="language-options">
                <button class="language-btn lang-en" onclick="selectLanguage('en')">
                    <i class="bi bi-translate"></i>
                    <div>English</div>
                </button>
                <button class="language-btn lang-si" onclick="selectLanguage('si')">
                    <i class="bi bi-translate"></i>
                    <div>‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</div>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="language-indicator" id="lang-indicator">
                <i class="bi bi-globe"></i>
                <span id="current-lang">English</span>
            </div>
            <h1>
                <i class="bi bi-tree header-icon"></i>
                <span id="app-title">AgriBot</span>
            </h1>
            <div class="disclaimer" id="app-subtitle">
                <i class="bi bi-info-circle"></i> <span>Your smart farming assistant - Powered by AI</span>
            </div>
        </div>

        <!-- Weather Widget -->
        <div class="weather-widget" id="weather-widget">
            <div class="weather-location-input">
                <input type="text" id="location-input" placeholder="Enter your location (e.g. Colombo)">
                <button id="get-weather-btn">
                    <i class="bi bi-cloud-sun"></i> Get Weather
                </button>
            </div>
            
            <div class="weather-display" id="weather-display">
                <div class="weather-main">
                    <div class="weather-icon" id="weather-icon">üå§Ô∏è</div>
                    <div class="weather-temp-info">
                        <div class="weather-location-name" id="weather-location">Location</div>
                        <div class="weather-temp" id="weather-temp">--¬∞C</div>
                        <div class="weather-description" id="weather-desc">--</div>
                    </div>
                </div>
                <div class="weather-details">
                    <div class="weather-detail-item" title="Humidity">
                        <span class="weather-detail-icon">üíß</span>
                        <span class="weather-detail-value" id="weather-humidity">--%</span>
                    </div>
                    <div class="weather-detail-item" title="Wind Speed">
                        <span class="weather-detail-icon">üí®</span>
                        <span class="weather-detail-value" id="weather-wind">-- km/h</span>
                    </div>
                    <div class="weather-detail-item" title="Feels Like">
                        <span class="weather-detail-icon">üå°Ô∏è</span>
                        <span class="weather-detail-value" id="weather-feels">--¬∞C</span>
                    </div>
                    <div class="weather-detail-item" title="Precipitation">
                        <span class="weather-detail-icon">üåßÔ∏è</span>
                        <span class="weather-detail-value" id="weather-precip">-- mm</span>
                    </div>
                </div>
                <button class="weather-change-btn" id="change-location-btn">
                    <i class="bi bi-geo-alt"></i> Change
                </button>
            </div>
        </div>

        <div id="chat-container"></div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="user-input" placeholder="Ask me anything about agriculture...">
                <button class="btn btn-primary" id="send-btn">
                    <i class="bi bi-send-fill"></i>
                    <span id="send-text">Send</span>
                </button>
            </div>

            <audio id="audio" controls style="display: none;"></audio>
        </div>

        <!-- <div class="footer">
            Made with <i class="bi bi-heart-fill" style="color: #dc3545;"></i> by Mohammed Ashraf
            <a href="https://www.linkedin.com/in/mohammed97ashraf" target="_blank"><i class="bi bi-linkedin"></i></a>
            <a href="https://github.com/mohammed97ashraf" target="_blank"><i class="bi bi-github"></i></a>
        </div> -->
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        // Language translations
        const translations = {
            en: {
                appTitle: 'AgriBot',
                appSubtitle: 'Your smart farming assistant - Powered by AI',
                inputPlaceholder: 'Ask me anything about agriculture...',
                sendBtn: 'Send',
                welcomeMsg: 'üëã Hello! I\'m AgriBot, your smart farming assistant. How can I help you today?',
                errorMsg: 'Sorry, something went wrong. Please try again.',
                processingAudio: 'Processing audio...',
                thinking: 'AgriBot is thinking...',
                langName: 'English',
                systemPrompt: 'You are a helpful agriculture chatbot assisting farmers with their queries. When providing agricultural advice, solutions, or instructions, always format your response in clear point-wise or numbered format for better readability. Use bullet points or numbers to break down steps, tips, or information. For simple greetings or general conversation, respond naturally without points. Always respond in English.'
            },
            si: {
                appTitle: '‡∂ö‡∑ò‡∑Ç‡∑í ‡∂∂‡∑ú‡∂ß‡∑ä',
                appSubtitle: '‡∂î‡∂∂‡∂ú‡∑ö ‡∂∂‡∑î‡∂Ø‡∑ä‡∂∞‡∑í‡∂∏‡∂≠‡∑ä ‡∂ú‡∑ú‡∑Ä‡∑í‡∂≠‡∑ê‡∂±‡∑ä ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö - AI ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∂∂‡∂Ω‡∂ú‡∂±‡∑ä‡∑Ä‡∑è ‡∂á‡∂≠',
                inputPlaceholder: '‡∂ö‡∑ò‡∑Ç‡∑í‡∂ö‡∂ª‡∑ä‡∂∏‡∂∫ ‡∂ú‡∑ê‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂±...',
                sendBtn: '‡∂∫‡∑Ä‡∂±‡∑ä‡∂±',
                welcomeMsg: 'üëã ‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! ‡∂∏‡∂∏ ‡∂ö‡∑ò‡∑Ç‡∑í ‡∂∂‡∑ú‡∂ß‡∑ä, ‡∂î‡∂∂‡∂ú‡∑ö ‡∂∂‡∑î‡∂Ø‡∑ä‡∂∞‡∑í‡∂∏‡∂≠‡∑ä ‡∂ú‡∑ú‡∑Ä‡∑í‡∂≠‡∑ê‡∂±‡∑ä ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö‡∂∫‡∑è. ‡∂Ö‡∂Ø ‡∂∏‡∂∏ ‡∂î‡∂∂‡∂ß ‡∂ö‡∑ô‡∑É‡∑ö ‡∂ã‡∂Ø‡∑Ä‡∑ä ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂Ø?',
                errorMsg: '‡∑É‡∂∏‡∑è‡∑Ä‡∂±‡∑ä‡∂±, ‡∂∫‡∂∏‡∂ö‡∑ä ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑ì ‡∂á‡∂≠. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.',
                processingAudio: '‡∑Ñ‡∂¨ ‡∑É‡∑ê‡∂ö‡∑É‡∑ô‡∂∏‡∑í‡∂±‡∑ä...',
                thinking: '‡∂ö‡∑ò‡∑Ç‡∑í ‡∂∂‡∑ú‡∂ß‡∑ä ‡∑É‡∑í‡∂≠‡∂∏‡∑í‡∂±‡∑ä...',
                langName: '‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω',
                systemPrompt: 'You are a helpful agriculture chatbot assisting farmers with their queries. When providing agricultural advice, solutions, or instructions, always format your response in clear point-wise or numbered format for better readability. Use bullet points or numbers to break down steps, tips, or information. For simple greetings or general conversation, respond naturally without points. Always respond in Sinhala language.'
            }
        };

        let currentLanguage = 'en';
        let systemPrompt = translations.en.systemPrompt;
        let currentLocation = '';

        // Define scrollToBottom globally so it can be accessed from anywhere
        function scrollToBottom() {
            $('#chat-container').scrollTop($('#chat-container')[0].scrollHeight);
        }

        function selectLanguage(lang) {
            currentLanguage = lang;
            systemPrompt = translations[lang].systemPrompt;
            updateUILanguage();
            $('#languageModal').fadeOut(300);
            
            // Show welcome message
            setTimeout(function() {
                $('#chat-container').append('<div class="message-wrapper bot-message"><div class="message-with-audio"><div class="bot-avatar">ü§ñ</div><div class="message-content">' + translations[lang].welcomeMsg + '</div></div></div>');
                scrollToBottom();
            }, 400);
        }

        function updateUILanguage() {
            const t = translations[currentLanguage];
            $('#app-title').text(t.appTitle);
            $('#app-subtitle span').text(t.appSubtitle);
            $('#user-input').attr('placeholder', t.inputPlaceholder);
            $('#send-text').text(t.sendBtn);
            $('#current-lang').text(t.langName);
        }

        window.selectLanguage = selectLanguage;

        $(document).ready(function() {
            // Weather functionality
            $('#get-weather-btn').on('click', function() {
                getWeather();
            });

            $('#location-input').on('keypress', function(e) {
                if (e.which === 13) {
                    getWeather();
                }
            });

            $('#change-location-btn').on('click', function() {
                $('#weather-widget').removeClass('compact');
                $('#weather-display').removeClass('active');
                $('#location-input').val('').focus();
                currentLocation = '';
            });

            function getWeather() {
                const location = $('#location-input').val().trim();
                if (location === '') {
                    alert('Please enter a location');
                    return;
                }

                currentLocation = location;
                $('#get-weather-btn').html('<i class="bi bi-arrow-repeat"></i> Loading...').prop('disabled', true);

                $.ajax({
                    url: '/weather',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ location: location }),
                    success: function(data) {
                        displayWeather(data);
                        $('#get-weather-btn').html('<i class="bi bi-cloud-sun"></i> Get Weather').prop('disabled', false);
                    },
                    error: function(xhr, status, error) {
                        alert('Unable to fetch weather data. Please check the location and try again.');
                        $('#get-weather-btn').html('<i class="bi bi-cloud-sun"></i> Get Weather').prop('disabled', false);
                    }
                });
            }

            function displayWeather(data) {
                $('#weather-location').text(data.location);
                $('#weather-temp').text(data.temperature + '¬∞C');
                $('#weather-desc').text(data.description);
                $('#weather-icon').text(data.icon);
                $('#weather-humidity').text(data.humidity + '%');
                $('#weather-wind').text(data.wind_speed + ' km/h');
                $('#weather-feels').text(data.feels_like + '¬∞C');
                $('#weather-precip').text(data.precipitation + ' mm');
                
                $('#weather-display').addClass('active');
                $('#weather-widget').addClass('compact');
            }

            window.getWeather = getWeather;

            $('#send-btn').on('click', function() {
                sendMessage();
            });

            $('#user-input').on('keypress', function(e) {
                if (e.which === 13) {
                    sendMessage();
                }
            });

            var recording = false;
            var recorder;

            function toggleRecording() {
                const t = translations[currentLanguage];
                if (recording) {
                    stopRecording();
                    $('#record-btn').removeClass('btn-recording');
                    $('#record-text').text(t.recordBtn);
                } else {
                    startRecording();
                    $('#record-btn').addClass('btn-recording');
                    $('#record-text').text(t.stopRecording);
                }
                recording = !recording;
            }

            
            function startRecording() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            recorder = new MediaRecorder(stream);
                            var chunks = [];
            
                            recorder.addEventListener('dataavailable', function(e) {
                                chunks.push(e.data);
                            });
            
                            recorder.addEventListener('stop', function() {
                                var audioBlob = new Blob(chunks, { type: 'audio/webm' });
                                var formData = new FormData();
                                formData.append('audio', audioBlob, 'audio.webm');
                                sendAudio(formData);
                            });
            
                            recorder.start();
                        })
                        .catch(function(err) {
                            console.error('Error accessing microphone:', err);
                            alert('Error accessing microphone. Please check permissions.');
                        });
                } else {
                    console.error('getUserMedia is not supported in this browser.');
                    alert('Audio recording is not supported in this browser.');
                }
            }


            function stopRecording() {
                if (recorder) {
                    recorder.stop();
                }
            }

            function sendAudio(formData) {
                const t = translations[currentLanguage];
                $('#chat-container').append('<div class="message-wrapper bot-message"><div class="loading-message"><div class="loading-dots"><span></span><span></span><span></span></div>' + t.processingAudio + '</div></div>');
                scrollToBottom();

                $.ajax({
                    url: '/chat',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        $('#chat-container .loading-message:last').parent().remove();

                        var transcription = response.text;
                        $('#user-input').val(transcription);
                        sendMessage();
                    },
                    error: function(xhr, status, error) {
                        $('#chat-container .loading-message:last').parent().remove();
                        console.error('Error uploading audio:', error);
                        alert('Error processing audio. Please try again.');
                    }
                });
            }

            function sendMessage() {
                var userInput = $('#user-input').val();
                if (userInput.trim() !== '') {
                    $('#user-input').val('');
                    $('#chat-container').append('<div class="message-wrapper user-message"><div class="message-content">' + escapeHtml(userInput) + '</div></div>');
                    scrollToBottom();

                    const t = translations[currentLanguage];
                    $('#chat-container').append('<div class="message-wrapper bot-message"><div class="loading-message"><div class="loading-dots"><span></span><span></span><span></span></div>' + t.thinking + '</div></div>');
                    scrollToBottom();

                    // Send message with language context and location
                    $.ajax({
                        url: '/chat',
                        method: 'POST',
                        data: {
                            text: userInput,
                            language: currentLanguage,
                            system_prompt: systemPrompt,
                            location: currentLocation
                        },
                        timeout: 60000, // 60 second timeout
                        success: function(response) {
                            // Remove loading message
                            $('#chat-container .loading-message:last').parent().remove();

                            var messageId = 'msg-' + Date.now();
                            var formattedText = formatBotMessage(response.text);
                            var messageHtml = '<div class="message-wrapper bot-message">' +
                                '<div class="message-with-audio">' +
                                '<div class="bot-avatar">ü§ñ</div>' +
                                '<div class="message-content-wrapper">' +
                                '<div class="message-content" id="' + messageId + '">' + formattedText + '</div>' +
                                '<button class="audio-play-btn" onclick="playAudio(\'' + messageId + '\', \'' + response.voice + '\')"><i class="bi bi-volume-up-fill"></i></button>' +
                                '</div></div></div>';
                            $('#chat-container').append(messageHtml);
                            scrollToBottom();

                            showNotification(response.text);
                        },
                        error: function(xhr, status, error) {
                            // Always remove loading message
                            $('#chat-container .loading-message:last').parent().remove();
                            
                            const t = translations[currentLanguage];
                            var errorMessage = t.errorMsg;
                            
                            // Provide specific error messages
                            if (status === 'timeout') {
                                errorMessage = 'Request timed out. Please try again.';
                            } else if (xhr.status === 500) {
                                errorMessage = 'Server error. Please try again later.';
                            }
                            
                            $('#chat-container').append('<div class="message-wrapper bot-message"><div class="message-with-audio"><div class="bot-avatar">ü§ñ</div><div class="message-content" style="color: #dc3545;">' + errorMessage + '</div></div></div>');
                            scrollToBottom();
                        }
                    });
                }
            }

            window.currentAudio = null;
            window.currentButton = null;

            window.playAudio = function(messageId, voiceFile) {
                var audio = document.getElementById('audio');
                var button = event.currentTarget;
                
                // If clicking the same button that's playing, pause it
                if (window.currentAudio === voiceFile && !audio.paused) {
                    audio.pause();
                    button.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
                    button.classList.remove('playing');
                    window.currentButton = null;
                    return;
                }
                
                // Reset previous button if exists
                if (window.currentButton) {
                    window.currentButton.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
                    window.currentButton.classList.remove('playing');
                }
                
                // Play new audio
                audio.pause();
                audio.src = voiceFile;
                audio.load();
                audio.play();
                
                button.innerHTML = '<i class="bi bi-pause-fill"></i>';
                button.classList.add('playing');
                window.currentAudio = voiceFile;
                window.currentButton = button;
                
                // Reset button when audio ends
                audio.onended = function() {
                    button.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
                    button.classList.remove('playing');
                    window.currentButton = null;
                };
            };

            function showNotification(message) {
                if (Notification.permission === "granted") {
                    var notification = new Notification("AgriBot", {
                        body: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                        icon: "{{ url_for('static', filename='images/favicon.ico') }}"
                    });
                } else if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(function(permission) {
                        if (permission === "granted") {
                            var notification = new Notification("AgriBot", {
                                body: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
                                icon: "{{ url_for('static', filename='images/favicon.ico') }}"
                            });
                        }
                    });
                }
            }

            function formatBotMessage(text) {
                // First, escape basic HTML
                var div = document.createElement('div');
                div.textContent = text;
                text = div.innerHTML;
                
                // Remove excessive blank lines
                text = text.replace(/\n{3,}/g, '\n\n');
                
                // Convert **Section Headings:** to proper h3 tags
                text = text.replace(/\*\*([^*\n]+):\*\*/g, '<h3>$1</h3>');
                
                // Convert numbered items with **bold title**: description
                text = text.replace(/^(\d+)\.\s+\*\*([^*]+)\*\*:\s*(.+?)$/gm, 
                    '<div class="list-item"><strong>$1. $2:</strong><span class="list-item-content">$3</span></div>');
                
                // Convert numbered items with regular title: description
                text = text.replace(/^(\d+)\.\s+([^:\n]+):\s*(.+?)$/gm, 
                    '<div class="list-item"><strong>$1. $2:</strong><span class="list-item-content">$3</span></div>');
                
                // Convert standalone **bold items** (without colons) in tips section
                text = text.replace(/\*\*([^*:]+)\*\*:\s*(.+?)(?=\n|$)/g, 
                    '<div class="list-item"><strong>$1:</strong><span class="list-item-content">$2</span></div>');
                
                // Convert bullet points
                text = text.replace(/^[\*\-]\s+(.+?)$/gm, '<li>$1</li>');
                
                // Wrap consecutive <li> in <ul>
                text = text.replace(/(<li>[\s\S]*?<\/li>)(?!\s*<li>)/g, '<ul>$1</ul>');
                text = text.replace(/<\/ul>\s*<ul>/g, '');
                
                // Convert Tips sections
                text = text.replace(/\*\*?(Tips and Precautions|Tips for [^:*]+|Additional Tips?)[:\*]*/gi, 
                    '<div class="tip-section"><div class="tip-title">üí° $1</div>');
                
                // Close tip sections
                text = text.replace(/(<div class="tip-section">[\s\S]*?)(?=<h3>|$)/g, function(match) {
                    if (!match.endsWith('</div>')) {
                        return match + '</div>';
                    }
                    return match;
                });
                
                // Remove remaining ** markers
                text = text.replace(/\*\*/g, '');
                
                // Clean up whitespace
                text = text.replace(/\n+(?=<)/g, '');
                text = text.replace(/>\n+/g, '>');
                
                // Convert paragraph breaks
                text = text.replace(/\n\n/g, '<br><br>');
                text = text.replace(/\n/g, ' ');
                
                // Remove extra spaces
                text = text.replace(/\s+/g, ' ');
                text = text.replace(/>\s+</g, '><');
                text = text.replace(/\s+>/g, '>');
                text = text.replace(/<\s+/g, '<');
                
                return text;
            }

            function escapeHtml(text) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
        });
    </script>
    
</body>
</html>
